{"ast":null,"code":"const axios = require('axios');\n// Importa o Token e a URL base (assume que getBimerToken.js está correto)\nconst {\n  getBimerAuthToken,\n  BIMER_API_URL\n} = require('../utils/getBimerToken');\nconst {\n  isRevendedorLogado\n} = require('../utils/revendedor'); // Assume que esta função existe\n\n// --- ENDPOINTS CORRETOS E CONFIRMADOS PARA GRUPOS/CATÁLOGO ---\nconst PRODUTO_ENDPOINT_LISTAGEM = '/api/grupos';\n// NOVO ENDPOINT: Usamos um placeholder para indicar que o ID do grupo será inserido aqui\nconst PRODUTO_ENDPOINT_BUSCA_GRUPO = '/api/produtos/Grupo';\n\n// --- FUNÇÃO DE LISTAGEM (CATÁLOGO DE GRUPOS) ---\nexports.listarProdutos = async (req, res) => {\n  // ... Código existente para verificar login e obter token ...\n  if (!isRevendedorLogado(req.session && req.session.cnpj)) {\n    // Se a regra for não logar, pode retornar uma mensagem de erro ou prosseguir\n    // Para fins de demonstração, vamos apenas logar e prosseguir, mas idealmente seria um return res.status(401).send(...)\n    console.log(\"Usuário não logado. Prosseguindo sem restrição de preço.\");\n  }\n  try {\n    const authToken = await getBimerAuthToken();\n\n    // 1. CHAMA O BIMER PARA OBTER A LISTA DE GRUPOS\n    const response = await axios.get(`${BIMER_API_URL}${PRODUTO_ENDPOINT_LISTAGEM}`, {\n      headers: {\n        'Authorization': `Bearer ${authToken}`\n      }\n    });\n\n    // 2. EXTRAI E TRATA OS DADOS DO BIMER\n    let dadosDoBimer = response.data.ListaObjetos || response.data;\n\n    // Mapeamento dos Grupos para a Estrutura Esperada pelo Frontend:\n    let produtosDoBimer = dadosDoBimer.map(grupo => ({\n      Identificador: grupo.Identificador,\n      Codigo: grupo.Codigo,\n      Nome: grupo.Nome,\n      // Valores mockados para a listagem inicial\n      precoVenda: \"R$ ----\",\n      descricao: `Grupo de Produtos: ${grupo.Nome}. Clique para mais detalhes.`,\n      categoria: grupo.Nome.toUpperCase() // Usando o nome como categoria para filtros\n    }));\n\n    // 3. REGRA DE PREÇO RESTRITO (Onde for necessário)\n    // Se for preciso mascarar/filtrar preços, o código viria aqui.\n    // Como a rota inicial é de grupos, mantemos o preço mockado.\n\n    // 4. RETORNA O JSON DOS GRUPOS\n    return res.status(200).json(produtosDoBimer);\n  } catch (error) {\n    const status = error.response ? error.response.status : 500;\n    console.error('ERRO CRÍTICO na listagem (Status da Requisição):', status);\n    if (error.response) {\n      console.error('Detalhe da Resposta do Erro (se houver):', error.response.data);\n    }\n    return res.status(status).json({\n      message: `Falha na listagem de grupos. Status: ${status}`\n    });\n  }\n};\n\n// --- FUNÇÃO PARA BUSCAR PRODUTOS POR ID DO GRUPO (AGORA LISTA PRODUTOS) ---\nexports.buscarProdutoPorId = async (req, res) => {\n  const grupoId = req.params.id; // Recebe o Identificador do Grupo\n\n  try {\n    const authToken = await getBimerAuthToken();\n\n    // 1. CHAMA O BIMER PARA LISTAR OS PRODUTOS DO GRUPO\n    // Assumindo que o endpoint é PRODUTOS/Grupo/{ID}\n    const response = await axios.get(`${BIMER_API_URL}${PRODUTO_ENDPOINT_BUSCA_GRUPO}/${grupoId}`, {\n      headers: {\n        'Authorization': `Bearer ${authToken}`\n      }\n    });\n\n    // 2. EXTRAI E TRATA OS DADOS DO BIMER (Lista de Produtos)\n    let dadosDoBimer = response.data.ListaObjetos || response.data;\n\n    // 3. Mapeamento dos Produtos para a Estrutura Esperada pelo Frontend:\n    // Adapte esta parte para o formato que o seu objeto Produto no Bimer retorna.\n    // Exemplo: Nome, PrecoVenda, Descricao\n    let produtosDoGrupo = dadosDoBimer.map(produto => ({\n      id: produto.Identificador,\n      // Usar o Identificador do Produto\n      nome: produto.Nome,\n      // Aplicar formatação de preço se o campo existir no objeto Bimer\n      preco: `R$ ${produto.PrecoVenda ? produto.PrecoVenda.toFixed(2).replace('.', ',') : '----'}`,\n      descricao: produto.Descricao || 'Sem descrição.',\n      codigo: produto.Codigo || ''\n      // Adicione outros campos necessários aqui\n    }));\n\n    // 4. RETORNA O JSON DOS PRODUTOS\n    return res.status(200).json(produtosDoGrupo);\n  } catch (error) {\n    const status = error.response ? error.response.status : 500;\n\n    // Verifica se o erro é falha na autenticação (Token expirado/inválido)\n    if (error.message.includes('Falha na autenticação do Bimer')) {\n      console.error('ERRO CRÍTICO (Token)', error.message);\n      return res.status(500).json({\n        message: error.message\n      });\n    }\n    console.error(`Erro ao buscar produtos do grupo ${grupoId}.`, error.message);\n    return res.status(status).json({\n      message: `Falha ao buscar detalhes do grupo. Status: ${status}`\n    });\n  }\n};","map":{"version":3,"names":["axios","require","getBimerAuthToken","BIMER_API_URL","isRevendedorLogado","PRODUTO_ENDPOINT_LISTAGEM","PRODUTO_ENDPOINT_BUSCA_GRUPO","exports","listarProdutos","req","res","session","cnpj","console","log","authToken","response","get","headers","dadosDoBimer","data","ListaObjetos","produtosDoBimer","map","grupo","Identificador","Codigo","Nome","precoVenda","descricao","categoria","toUpperCase","status","json","error","message","buscarProdutoPorId","grupoId","params","id","produtosDoGrupo","produto","nome","preco","PrecoVenda","toFixed","replace","Descricao","codigo","includes"],"sources":["C:/Users/Ouro Branco/Desktop/ourobranco-site/frontend/src/App.jsx"],"sourcesContent":["const axios = require('axios');\r\n// Importa o Token e a URL base (assume que getBimerToken.js está correto)\r\nconst { getBimerAuthToken, BIMER_API_URL } = require('../utils/getBimerToken');\r\nconst { isRevendedorLogado } = require('../utils/revendedor'); // Assume que esta função existe\r\n\r\n// --- ENDPOINTS CORRETOS E CONFIRMADOS PARA GRUPOS/CATÁLOGO ---\r\nconst PRODUTO_ENDPOINT_LISTAGEM = '/api/grupos'; \r\n// NOVO ENDPOINT: Usamos um placeholder para indicar que o ID do grupo será inserido aqui\r\nconst PRODUTO_ENDPOINT_BUSCA_GRUPO = '/api/produtos/Grupo'; \r\n\r\n// --- FUNÇÃO DE LISTAGEM (CATÁLOGO DE GRUPOS) ---\r\nexports.listarProdutos = async (req, res) => {\r\n    // ... Código existente para verificar login e obter token ...\r\n    if (!isRevendedorLogado(req.session && req.session.cnpj)) {\r\n        // Se a regra for não logar, pode retornar uma mensagem de erro ou prosseguir\r\n        // Para fins de demonstração, vamos apenas logar e prosseguir, mas idealmente seria um return res.status(401).send(...)\r\n        console.log(\"Usuário não logado. Prosseguindo sem restrição de preço.\");\r\n    }\r\n    \r\n    try {\r\n        const authToken = await getBimerAuthToken();\r\n        \r\n        // 1. CHAMA O BIMER PARA OBTER A LISTA DE GRUPOS\r\n        const response = await axios.get(`${BIMER_API_URL}${PRODUTO_ENDPOINT_LISTAGEM}`, {\r\n            headers: {\r\n                'Authorization': `Bearer ${authToken}`,\r\n            },\r\n        });\r\n\r\n        // 2. EXTRAI E TRATA OS DADOS DO BIMER\r\n        let dadosDoBimer = response.data.ListaObjetos || response.data;\r\n        \r\n        // Mapeamento dos Grupos para a Estrutura Esperada pelo Frontend:\r\n        let produtosDoBimer = dadosDoBimer.map(grupo => ({\r\n            Identificador: grupo.Identificador,\r\n            Codigo: grupo.Codigo,\r\n            Nome: grupo.Nome,\r\n            // Valores mockados para a listagem inicial\r\n            precoVenda: \"R$ ----\", \r\n            descricao: `Grupo de Produtos: ${grupo.Nome}. Clique para mais detalhes.`,\r\n            categoria: grupo.Nome.toUpperCase(), // Usando o nome como categoria para filtros\r\n        }));\r\n        \r\n        // 3. REGRA DE PREÇO RESTRITO (Onde for necessário)\r\n        // Se for preciso mascarar/filtrar preços, o código viria aqui.\r\n        // Como a rota inicial é de grupos, mantemos o preço mockado.\r\n\r\n        // 4. RETORNA O JSON DOS GRUPOS\r\n        return res.status(200).json(produtosDoBimer);\r\n\r\n    } catch (error) {\r\n        const status = error.response ? error.response.status : 500;\r\n        console.error('ERRO CRÍTICO na listagem (Status da Requisição):', status);\r\n        if (error.response) {\r\n            console.error('Detalhe da Resposta do Erro (se houver):', error.response.data);\r\n        }\r\n        \r\n        return res.status(status).json({\r\n            message: `Falha na listagem de grupos. Status: ${status}`,\r\n        });\r\n    }\r\n};\r\n\r\n\r\n// --- FUNÇÃO PARA BUSCAR PRODUTOS POR ID DO GRUPO (AGORA LISTA PRODUTOS) ---\r\nexports.buscarProdutoPorId = async (req, res) => {\r\n    const grupoId = req.params.id; // Recebe o Identificador do Grupo\r\n    \r\n    try {\r\n        const authToken = await getBimerAuthToken();\r\n\r\n        // 1. CHAMA O BIMER PARA LISTAR OS PRODUTOS DO GRUPO\r\n        // Assumindo que o endpoint é PRODUTOS/Grupo/{ID}\r\n        const response = await axios.get(`${BIMER_API_URL}${PRODUTO_ENDPOINT_BUSCA_GRUPO}/${grupoId}`, {\r\n            headers: {\r\n                'Authorization': `Bearer ${authToken}`,\r\n            },\r\n        });\r\n\r\n        // 2. EXTRAI E TRATA OS DADOS DO BIMER (Lista de Produtos)\r\n        let dadosDoBimer = response.data.ListaObjetos || response.data;\r\n        \r\n        // 3. Mapeamento dos Produtos para a Estrutura Esperada pelo Frontend:\r\n        // Adapte esta parte para o formato que o seu objeto Produto no Bimer retorna.\r\n        // Exemplo: Nome, PrecoVenda, Descricao\r\n        let produtosDoGrupo = dadosDoBimer.map(produto => ({\r\n            id: produto.Identificador, // Usar o Identificador do Produto\r\n            nome: produto.Nome,\r\n            // Aplicar formatação de preço se o campo existir no objeto Bimer\r\n            preco: `R$ ${produto.PrecoVenda ? produto.PrecoVenda.toFixed(2).replace('.', ',') : '----'}`,\r\n            descricao: produto.Descricao || 'Sem descrição.',\r\n            codigo: produto.Codigo || '',\r\n            // Adicione outros campos necessários aqui\r\n        }));\r\n\r\n        // 4. RETORNA O JSON DOS PRODUTOS\r\n        return res.status(200).json(produtosDoGrupo);\r\n\r\n    } catch (error) {\r\n        const status = error.response ? error.response.status : 500;\r\n        \r\n        // Verifica se o erro é falha na autenticação (Token expirado/inválido)\r\n        if (error.message.includes('Falha na autenticação do Bimer')) {\r\n            console.error('ERRO CRÍTICO (Token)', error.message);\r\n            return res.status(500).json({\r\n                message: error.message,\r\n            });\r\n        }\r\n\r\n        console.error(`Erro ao buscar produtos do grupo ${grupoId}.`, error.message);\r\n        return res.status(status).json({\r\n            message: `Falha ao buscar detalhes do grupo. Status: ${status}`,\r\n        });\r\n    }\r\n};"],"mappings":"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","ignoreList":[]},"metadata":{},"sourceType":"module","externalDependencies":[]}